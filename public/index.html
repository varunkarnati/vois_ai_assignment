<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>☕ Voice AI Restaurant Assistant</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://images.unsplash.com/photo-1600891964599-f61ba0e24092?auto=format&fit=crop&w=1400&q=80') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      min-height: 100vh;
      padding-top: 2rem;
      margin: 0;
    }

    .container {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 2rem;
      border-radius: 15px;
      max-width: 800px;
      width: 90%;
    }

    h1 {
      text-align: center;
      color: #ffcc70;
    }

    .orb {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #6c757d;
      margin: 1rem auto;
      transition: 0.3s all;
    }

    .orb.listening { background-color: #4a90e2; }
    .orb.speaking { background-color: #50e3c2; }
    .orb.idle { background-color: #6c757d; }

    #status {
      margin: 1rem;
      text-align: center;
    }

    .btn {
      background-color: #ff914d;
      color: white;
      border: none;
      padding: 0.6rem 1.6rem;
      font-size: 1rem;
      border-radius: 25px;
      cursor: pointer;
      margin: 0.5rem;
    }

    .btn:hover { background-color: #ff7f24; }
    .btn.end { background-color: #e94f4f; }
    .btn.end:hover { background-color: #c93d3d; }

    #transcript-box {
      background-color: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .message { margin-bottom: 0.8rem; }
    .message.user { color: #ffa07a; }
    .message.assistant { color: #b0e0e6; }

    details {
      background-color: rgba(255, 255, 255, 0.1);
      padding: 1rem;
      border-radius: 10px;
      margin-top: 1rem;
    }

    summary {
      font-weight: bold;
      cursor: pointer;
    }

    ul { list-style: none; padding-left: 1rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>☕ Voice Assistant</h1>
    <div class="orb idle" id="orb"></div>
    <div id="status">Press Start to Begin</div>
    <div style="text-align: center">
      <button class="btn" onclick="startConversation()">Start Conversation</button>
      <button class="btn end" onclick="endConversation()">End Conversation</button>
    </div>

    <div id="transcript-box"></div>

    <details>
      <summary>View Order Details</summary>
      <ul id="order-items"></ul>
      <p id="order-total">Total: $0.00</p>
    </details>
  </div>

  <audio id="audio" autoplay></audio>

  <script>
    const statusEl = document.getElementById("status");
    const orb = document.getElementById("orb");
    const audioEl = document.getElementById("audio");
    const transcriptBox = document.getElementById("transcript-box");
    let ws = null;
    let pendingEnd = false;

    function updateStatus(text, state = "idle") {
      statusEl.textContent = text;
      orb.className = `orb ${state}`;
    }

    function appendMessage(role, text) {
      const msg = document.createElement("div");
      msg.className = `message ${role}`;
      msg.textContent = `${role === 'user' ? 'You' : 'Assistant'}: ${text}`;
      transcriptBox.appendChild(msg);
      transcriptBox.scrollTop = transcriptBox.scrollHeight;
    }

    function startConversation() {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const wsUrl = `${protocol}://${location.host}/ws/converse`;
      ws = new WebSocket(wsUrl);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        updateStatus("Connected. Waiting for greeting...", "idle");
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.transcript) appendMessage("assistant", data.transcript);
        if (data.order) updateOrderSummary(data.order.items, data.order.total);

        if (data.audio) {
          const audio = base64ToBlobUrl(data.audio);
          audioEl.src = audio;
          audioEl.onended = () => {
            if (pendingEnd) {
              cleanupConversation();
            } else {
              updateStatus("Listening...", "listening");
            }
          };
          updateStatus("Assistant speaking...", "speaking");
        }
      };

      ws.onerror = () => updateStatus("WebSocket error.", "idle");
    }

    function endConversation() {
      pendingEnd = true;
      updateStatus("Ending after current response...", "idle");
    }

    function cleanupConversation() {
      if (ws) ws.close();
      updateStatus("❌ Conversation Ended", "idle");
      pendingEnd = false;
    }

    function base64ToBlobUrl(base64) {
      const binaryString = atob(base64);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const blob = new Blob([bytes], { type: "audio/wav" });
      return URL.createObjectURL(blob);
    }

    function updateOrderSummary(items, total) {
      const list = document.getElementById("order-items");
      const totalEl = document.getElementById("order-total");
      list.innerHTML = "";
      items.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item;
        list.appendChild(li);
      });
      totalEl.textContent = `Total: $${total.toFixed(2)}`;
    }
  </script>
</body>
</html>